{% extends 'layout/master.html' %}

{% block title %}Inquiries List{% endblock %}

{% block layout %}
<!-- Layout wrapper: Start -->
<div class="layout-wrapper layout-content-navbar {{ is_menu|yesno:',layout-without-menu' }}">
<div class="layout-container">

    {% if is_menu %}
    <!-- Menu: Start -->
    {% include "parts/vertical_menu.html" %}
    <!-- Menu: End -->
    {% endif %}

    <!-- Layout page: Start -->
    <div class="layout-page">


    {% if is_navbar %}
    <!-- Navbar: Start -->
    {% include "parts/navbar.html" %}
    <!-- Navbar: End -->
    {% endif %}

<!-- ######################################################################### -->
    <!-- Content wrapper: Start -->
    <div class="content-wrapper">
        <div class="container">
            
            <center><h2>Inquiries List</h2></center>
            <br>
            <!-- Container for search rows -->
            <div id="search-container">
                <!-- Original search row -->
                <div class="search-row">
                    <!-- Display dynamic search form with language dropdown -->
                    <form method="get" action="{% url 'inquiries_list' %}" >

                        <div class="mysearsh row g-3">

                            {% for search_field in search_fields%}
                                <div class="col-md-3">
                                    <label for="search_field">Search By:</label>
                                    <select id="search_field" name="search_field" class="form-control" onchange="updatePlaceholder(this)">
                                        <option value="id" {% if search_field.name == 'id' %}selected{% endif %} selected>ID</option>
                                        <option value="name" {% if search_field.name == 'name' %}selected{% endif %}>Name</option>
                                        <option value="date" {% if search_field.name == 'date' %}selected{% endif %}>Register Date</option>
                                        <option value="add_name" {% if search_field.name == 'add_name' %}selected{% endif %}>Address Name</option>
                                        <option value="language" {% if search_field.name == 'language' %}selected{% endif %}>Language</option>
                                        <option value="nationality" {% if search_field.name == 'nationality' %}selected{% endif %}>Nationality</option>
                                        <option value="source" {% if search_field.name == 'source' %}selected{% endif %}>Source</option>
                                        <option value="status" {% if search_field.name == 'status' %}selected{% endif %}>Status</option>
                                        <option value="reminder" {% if search_field.name == 'reminder' %}selected{% endif %}>reminder</option>
                                    </select>
                                </div>
                                {% if search_field.name == "date" %}

                                <div id="myinput" class="col-md-6">
                                    <label for="start_date">Start Date:</label>
                                    <input type="date" name="start_date" class="form-control" value="{{ search_field.start_date }}" placeholder="Enter start date..." aria-label="Start Date">
                                    <label for="end_date">End Date:</label>
                                    <input type="date" name="end_date" class="form-control" value="{{ search_field.end_date }}" placeholder="Enter end date..." aria-label="End Date"><br>
                                </div>
                                <br>
                                {% elif search_field.name  == "language" %}
                                <div id="myinput" class="col-md-6">
                                    <label for="search_field">Search By:</label>
                                    <select name="language" class="form-control">
                                        <option value="{{ search_field.value }}" selected="">{{ search_field.value }}</option>
                                        {% for language in languages %}
                                            <option value="{{ language.name }}">{{ language.name }}</option>
                                        {% endfor %}

                                    </select>
                                </div>
                                {% elif search_field.name  == "reminder" %}
                                <div id="myinput" class="col-md-6">
                                    <label for="search_field">Search By:</label>
                                    <select name="reminder" class="form-control">
                                        {% if search_field.value %}
                                            <option value="{{ search_field.value }}" selected="">{{ search_field.value }}</option>
                                        {% endif %}

                                        <option value="1">Reminder today or tomorrow</option>
                                        <option value="2">Reminder next 1 months</option>
                                        <option value="3">Reminder next 3 months</option>
                                        <option value="4">Reminder next 6 months</option>
                                        <option value="5">Reminder next 12 months</option>


                                    </select>
                                </div>

                                {% elif search_field.name  == "nationality" %}
                                <div id="myinput" class="col-md-6">
                                    <label for="search_field">Search By:</label>
                                    <select name="nationality" class="form-control">
                                        <option value="{{ search_field.value }}" selected="">{{ search_field.value }}</option>
                                        {% for nat in nationality %}
                                            <option value="{{ nat.name }}">{{ nat.name }}</option>
                                        {% endfor %}

                                    </select>
                                </div>

                                {% elif search_field.name  == "source" %}
                                <div id="myinput" class="col-md-6">
                                    <label for="search_field">Search By:</label>
                                    <select name="source" class="form-control">
                                        <option value="{{ search_field.value }}" selected="">{{ search_field.value }}</option>
                                        {% for source in sources %}
                                            <option value="{{ source.name }}">{{ source.name }}</option>
                                        {% endfor %}

                                    </select>
                                </div>

                                {% elif search_field.name  == "status" %}
                                <div id="myinput" class="col-md-6">
                                    <label for="search_field">Search By:</label>
                                    <select name="status" class="form-control">
                                        <option value="{{ search_field.value }}" selected="">{{ search_field.value }}</option>
                                        {% for state in states %}
                                            <option value="{{ state.name }}">{{ state.name }}</option>
                                        {% endfor %}

                                    </select>
                                </div>


                                {% else %}
                                <div id="myinput" class="col-md-6">
                                    <label for="search_value">Search Value:</label>
                                    <input type="text" name="{{ search_field.name }}" class="form-control" value="{{ search_field.value }}" placeholder='{{ search_field.name }} ....' aria-label="Search Value">
                                </div>
                                {% endif %}
                                <br>
                            {% endfor %}

                            <div class="col-md-3">
                                <label for="search_field">Search By:</label>
                                <select id="search_field" name="search_field" class="form-control" onchange="updatePlaceholder(this)">
                                    <option value="id" {% if search_field == 'id' %}selected{% endif %} selected>ID</option>
                                    <option value="name" {% if search_field == 'name' %}selected{% endif %}>Name</option>
                                    <option value="date" {% if search_field == 'date' %}selected{% endif %}>Register Date</option>
                                    <option value="add_name" {% if search_field == 'add_name' %}selected{% endif %}>Address Name</option>
                                    <option value="language" {% if search_field == 'language' %}selected{% endif %}>Language</option>
                                    <option value="nationality" {% if search_field == 'nationality' %}selected{% endif %}>Nationality</option>
                                    <option value="source" {% if search_field == 'source' %}selected{% endif %}>Source</option>
                                    <option value="status" {% if search_field.name == 'status' %}selected{% endif %}>Status</option>
                                    <option value="reminder" {% if search_field.name == 'reminder' %}selected{% endif %}>reminder</option>
                                </select>
                            </div>

                            
                            <div id="myinput" class="col-md-6">
                                <label for="search_value">Search Value:</label>
                                <input type="text" name="id" class="form-control" value="{{ search_value }}" placeholder="Enter search value..." aria-label="Search Value">
                            </div>
                        </div>

                        <div id="mycontainer"> </div>

                        <div >
                            <br>
                            <button class="btn btn-secondary" type="button" onclick="addSearchRow()" onchange="addSearchRow(this)">Add Another Search</button>
                            <button class="btn btn-primary" type="submit">Search</button>
                        </div>

                    </form>
                </div>
            </div>
            
            <script>

                function updatePlaceholder(select) {
                        var searchField = select.value;
                        var searchContainer = select.parentElement.nextElementSibling;
                        var searchValue = searchContainer.querySelector('.form-control');

                        // Remove existing elements in the search container
                        searchContainer.innerHTML = '';

                        // Define the placeholders for each search field
                        var placeholders = {
                            'id': 'Enter ID...',
                            'name': 'Enter Name...',
                            'service': 'Enter Service...',
                            'number': 'Enter Phone Number...',
                            'date': 'Enter Register Date...',
                            'add_name': 'Enter Address Name...',
                            'language': 'Select Language...',
                            'nationality': 'Select Nationality...',
                            'source': 'Enter Source...',
                            'status': 'Select status...',
                            'reminder': 'Select reminder...'
                        };
                        var names = {
                            'id': 'id',
                            'name': 'name',
                            'service': 'service',
                            'number': 'number',
                            'date': 'date',
                            'add_name': 'add_name',
                            'language': 'language',
                            'nationality': 'nationality',
                            'status': 'status',
                            'source': 'source',
                            'reminder': 'reminder'
                        };

                        // Set the placeholder based on the selected search field
                        searchValue.placeholder = placeholders[searchField];
                        searchValue.name = names[searchField];

                        // Change the input type to 'date' for the 'date' field
                        if (searchField === 'date') {
                            searchValue.type = 'date';

                            // Create labels and input fields for the start and end dates
                            var labelStart = document.createElement('label');
                            labelStart.htmlFor = 'start_date';
                            labelStart.textContent = 'Start Date:';

                            var inputStart = document.createElement('input');
                            inputStart.type = 'date';
                            inputStart.id = 'start_date';
                            inputStart.name = 'start_date';
                            inputStart.className = 'form-control';

                            var labelEnd = document.createElement('label');
                            labelEnd.htmlFor = 'end_date';
                            labelEnd.textContent = 'End Date:';

                            var inputEnd = document.createElement('input');
                            inputEnd.type = 'date';
                            inputEnd.id = 'end_date';
                            inputEnd.name = 'end_date';
                            inputEnd.className = 'form-control';

                            // Append labels and input fields to the search container
                            searchContainer.appendChild(labelStart);
                            searchContainer.appendChild(inputStart);
                            searchContainer.appendChild(labelEnd);
                            searchContainer.appendChild(inputEnd);
                        }

                        // Fetch data for the 'language' field using AJAX
                        else if (searchField === 'language') {
                            var label = document.createElement('label');
                            label.htmlFor = 'search_field';
                            label.textContent = 'Search By:';

                            var input = document.createElement('input');
                            input.id = 'search_field';
                            input.className = 'form-control';
                            input.setAttribute('onchange', 'updatePlaceholder(this)');
                            input.placeholder = placeholders[searchField];
                            input.name = names[searchField];

                            // Append the new row inside the search container
                            searchContainer.appendChild(label);
                            //searchContainer.appendChild(input);

                            $.get("{% url 'get_languages' %}", function (data) {
                                var options = '<option value="" selected>Select Language...</option>';
                                data["data"].forEach(function (language) {
                                    options += '<option value="' + language + '">' + language + '</option>';
                                });

                                var selection = document.createElement('select');
                                selection.name = "language";
                                selection.className = 'form-control';
                                selection.innerHTML = options;

                                // Append the language select element to the search container
                                searchContainer.appendChild(selection);
                            });
                        }
                        
                        // Fetch data for the 'service' field using AJAX
                        else if (searchField === 'service') {
                            var label = document.createElement('label');
                            label.htmlFor = 'search_field';
                            label.textContent = 'Search By:';

                            var input = document.createElement('input');
                            input.id = 'search_field';
                            input.className = 'form-control';
                            input.setAttribute('onchange', 'updatePlaceholder(this)');
                            input.placeholder = placeholders[searchField];
                            input.name = names[searchField];

                            // Append the new row inside the search container
                            searchContainer.appendChild(label);
                            //searchContainer.appendChild(input);

                            $.get("{% url 'get_services' %}", function (data) {
                                var options = '<option value="" selected>Select Service...</option>';
                                data["data"].forEach(function (service) {
                                    options += '<option value="' + service + '">' + service + '</option>';
                                });

                                var selection = document.createElement('select');
                                selection.name = "service";
                                selection.className = 'form-control';
                                selection.innerHTML = options;

                                // Append the service select element to the search container
                                searchContainer.appendChild(selection);
                            });
                        }
                        
                        // Fetch data for the 'reminder' field using AJAX
                        else if (searchField === 'reminder') {
                            var label = document.createElement('label');
                            label.htmlFor = 'search_field';
                            label.textContent = 'Search By:';

                            var input = document.createElement('input');
                            input.id = 'search_field';
                            input.className = 'form-control';
                            input.setAttribute('onchange', 'updatePlaceholder(this)');
                            input.placeholder = placeholders[searchField];
                            input.name = names[searchField];

                            // Append the new row inside the search container
                            searchContainer.appendChild(label);
                            //searchContainer.appendChild(input);


                                var options = '<option value="" selected>Select Reminder intervale ...</option>';

                                    options += '<option value="' + 1 + '">' + 'Reminder today or tomorrow' + '</option>';
                                    options += '<option value="' + 2 + '">' + 'Reminder next 1 months' + '</option>';
                                    options += '<option value="' + 3 + '">' + 'Reminder next 3 months' + '</option>';
                                    options += '<option value="' + 4 + '">' + 'Reminder next 6 months' + '</option>';
                                    options += '<option value="' + 5 + '">' + 'Reminder next 12 months' + '</option>';


                                var selection = document.createElement('select');
                                selection.name = "reminder";
                                selection.className = 'form-control';
                                selection.innerHTML = options;

                                // Append the reminder select element to the search container
                                searchContainer.appendChild(selection);

                        }

                        // Fetch data for the 'nationality' field using AJAX
                        else if (searchField === 'nationality') {
                            var label = document.createElement('label');
                            label.htmlFor = 'search_field';
                            label.textContent = 'Search By:';

                            var input = document.createElement('input');
                            input.id = 'search_field';
                            input.className = 'form-control';
                            input.setAttribute('onchange', 'updatePlaceholder(this)');
                            input.placeholder = placeholders[searchField];
                            input.name = names[searchField];

                            // Append the new row inside the search container
                            searchContainer.appendChild(label);
                            //searchContainer.appendChild(input);

                            $.get("{% url 'get_nationalities' %}", function (data) {
                                var options = '<option value="" selected>Select Nationality...</option>';
                                data["data"].forEach(function (nationality) {
                                    options += '<option value="' + nationality + '">' + nationality + '</option>';
                                });

                                var selection = document.createElement('select');
                                selection.name = "nationality";
                                selection.className = 'form-control';
                                selection.innerHTML = options;

                                // Append the nationality select element to the search container
                                searchContainer.appendChild(selection);
                            });
                        }

                        // Fetch data for the 'source' field using AJAX
                        else if (searchField === 'source') {
                            var label = document.createElement('label');
                            label.htmlFor = 'search_field';
                            label.textContent = 'Search By:';

                            var input = document.createElement('input');
                            input.id = 'search_field';
                            input.className = 'form-control';
                            input.setAttribute('onchange', 'updatePlaceholder(this)');
                            input.placeholder = placeholders[searchField];
                            input.name = names[searchField];

                            // Append the new row inside the search container
                            searchContainer.appendChild(label);
                            //searchContainer.appendChild(input);

                            $.get("{% url 'get_sources' %}", function (data) {
                                var options = '<option value="" selected>Select Source...</option>';
                                data["data"].forEach(function (source) {
                                    options += '<option value="' + source + '">' + source + '</option>';
                                });

                                var selection = document.createElement('select');
                                selection.name = "source";
                                selection.className = 'form-control';
                                selection.innerHTML = options;

                                // Append the source select element to the search container
                                searchContainer.appendChild(selection);
                            });
                        }

                        // Fetch data for the 'status' field using AJAX
                        else if (searchField === 'status') {
                            var label = document.createElement('label');
                            label.htmlFor = 'search_field';
                            label.textContent = 'Search By:';

                            var input = document.createElement('input');
                            input.id = 'search_field';
                            input.className = 'form-control';
                            input.setAttribute('onchange', 'updatePlaceholder(this)');
                            input.placeholder = placeholders[searchField];
                            input.name = names[searchField];

                            // Append the new row inside the search container
                            searchContainer.appendChild(label);
                            //searchContainer.appendChild(input);

                            $.get("{% url 'get_status' %}", function (data) {
                                var options = '<option value="" selected>Select Status...</option>';
                                data["data"].forEach(function (status) {
                                    options += '<option value="' + status + '">' + status + '</option>';
                                });

                                var selection = document.createElement('select');
                                selection.name = "status";
                                selection.className = 'form-control';
                                selection.innerHTML = options;

                                // Append the status select element to the search container
                                searchContainer.appendChild(selection);
                            });
                        }

                        // For other fields (not 'date', 'language', 'nationality', or 'source', 'status'), create a standard input field
                        else {
                            var label = document.createElement('label');
                            label.htmlFor = 'search_field';
                            label.textContent = 'Search By:';

                            var input = document.createElement('input');
                            input.id = 'search_field';
                            input.className = 'form-control';
                            input.setAttribute('onchange', 'updatePlaceholder(this)');
                            input.placeholder = placeholders[searchField];
                            input.name = names[searchField];

                            // Append the new row inside the search container
                            searchContainer.appendChild(label);
                            searchContainer.appendChild(input);
                        }
                    }

                function addSearchRow() {
                    // Create a new search row
                    var newRow = document.createElement('div');
                    newRow.className = 'mysearsh row g-3';
            
                    var col1 = document.createElement('div');
                    col1.className = 'col-md-3';
            
                    var label = document.createElement('label');
                    label.htmlFor = 'search_field';
                    label.textContent = 'Search By:';
            
                    var select = document.createElement('select');
                    select.id = 'search_field';
                    select.name = 'search_field';
                    select.className = 'form-control';
                    select.setAttribute('onchange', 'updatePlaceholder(this)');
            
                    // Add options to the select element
                    var options = ['id', 'name', 'service', 'number', 'date', 'add_name', 'language', 'nationality', 'source'];
                    options.forEach(function (option) {
                        var opt = document.createElement('option');
                        opt.value = option;
                        opt.textContent = option.charAt(0).toUpperCase() + option.slice(1).replace('_', ' ');
                        select.appendChild(opt);
                    });
            
                    col1.appendChild(label);
                    col1.appendChild(select);
            
                    var col2 = document.createElement('div');
                    col2.id = 'myinput';
                    col2.className = 'col-md-6';
            
                    label = document.createElement('label');
                    label.htmlFor = 'search_value';
                    label.textContent = 'Search Value:';
            
                    var input = document.createElement('input');
                    input.type = 'text';
                    input.name = 'search_value';
                    input.className = 'form-control';
                    input.placeholder = 'Enter search value...';
                    input.setAttribute('aria-label', 'Search Value');
            
                    col2.appendChild(label);
                    col2.appendChild(input);
            
                    newRow.appendChild(col1);
                    newRow.appendChild(col2);
            
                    // Append the new row inside the search container
                    document.getElementById('mycontainer').appendChild(newRow);
                }
            </script>

            <div id="update">

                <hr>
                <h4 style="text-align: center;">we found {{ search_counter }} result</h4>
                <hr>

                <!-- Table to display customer information -->
                <style>
                    /* Define the width of the th elements */
                    th {
                        white-space: nowrap; /* Prevent line breaks */
                        overflow: hidden; /* Hide overflow content */
                        text-overflow: ellipsis; /* Add ellipsis for overflow text */
                    }
                    .line {
                        white-space: nowrap; /* Prevent line breaks */
                        overflow: hidden; /* Hide overflow content */
                        text-overflow: ellipsis; /* Add ellipsis for overflow text */
                        font-size: 12px;
                    }
                    </style>
                <table class="table">
                    <thead>
                        <tr>

                            <th >
                                <strong id="inquiry_id_sort" style="cursor: pointer;">inquiries id <span>&#8595;</span></strong>
                                <br>
                                <strong id="customer_id_sort" style="cursor: pointer;" >Customer id <span>&#8595;</span></strong>
                            
                                <script>
                                    // Get the inquiry_id_sort element
                                    var inquiryIdSort = document.getElementById("inquiry_id_sort");
                                
                                    // Read the current sort order from the query parameters in the URL
                                    var urlParams = new URLSearchParams(window.location.search);
                                    var currentSortOrder0 = urlParams.get('inq_id');
                                
                                    // Set the initial arrow icon based on the current sort order
                                    var arrowIcon = inquiryIdSort.querySelector("span");
                                    arrowIcon.innerHTML = currentSortOrder0 === "asc" ? "&#8593;" : "&#8595;";
                                
                                    // Add a click event listener to the element
                                    inquiryIdSort.addEventListener("click", function() {
                                        // Toggle the sort order
                                        var newSortOrder = currentSortOrder0 === "asc" ? "desc" : "asc";
                                
                                        // Update the link href with the new sort field and sort order
                                        inquiryIdSort.href = '{{ inquiries_list }}' + "?sort_field=inq_id&inq_id=" + newSortOrder;
                                        
                                        // Redirect to the new URL with the sort field and sort order
                                        window.location.href = "?sort_field=inq_id&inq_id=" + newSortOrder;
                                    });
                                </script>
                                <script>
                                    // Get the inquiry_id_sort element
                                    var inquiryIdSort = document.getElementById("customer_id_sort");
                                
                                    // Read the current sort order from the query parameters in the URL
                                    var urlParams = new URLSearchParams(window.location.search);
                                    var currentSortOrder = urlParams.get('customer_id');
                                
                                    // Set the initial arrow icon based on the current sort order
                                    var arrowIcon = inquiryIdSort.querySelector("span");
                                    arrowIcon.innerHTML = currentSortOrder === "asc" ? "&#8593;" : "&#8595;";
                                
                                    // Add a click event listener to the element
                                    inquiryIdSort.addEventListener("click", function() {
                                        // Toggle the sort order
                                        var newSortOrder = currentSortOrder === "asc" ? "desc" : "asc";
                                
                                        // Update the link href with the new sort field and sort order
                                        inquiryIdSort.href = '{{ inquiries_list }}' + "?sort_field=customer_id&customer_id=" + newSortOrder;
                                        
                                        // Redirect to the new URL with the sort field and sort order
                                        window.location.href = "?sort_field=customer_id&customer_id=" + newSortOrder;
                                    });
                                </script>
                            </th>
                            

                            <th >
                                <strong id="creation_sort" style="cursor: pointer;" >inquiry date <span>&#8595;</span></strong>
                                <br>
                                <strong id="update_sort" style="cursor: pointer;" >Update date <span>&#8595;</span></strong>

                                <script>
                                    // Get the inquiry_id_sort element
                                    var creationSort = document.getElementById("creation_sort");
                                
                                    // Read the current sort order from the query parameters in the URL
                                    var urlParams = new URLSearchParams(window.location.search);
                                    var currentSortOrder1 = urlParams.get('creation');
                                
                                    // Set the initial arrow icon based on the current sort order
                                    var arrowIcon = creationSort.querySelector("span");
                                    arrowIcon.innerHTML = currentSortOrder1 === "asc" ? "&#8593;" : "&#8595;";
                                
                                    // Add a click event listener to the element
                                    creationSort.addEventListener("click", function() {
                                        // Toggle the sort order
                                        var newSortOrder = currentSortOrder1 === "asc" ? "desc" : "asc";
                                
                                        // Update the link href with the new sort field and sort order
                                        creationSort.href = '{{ inquiries_list }}' + "?sort_field=creation&creation=" + newSortOrder;
                                        
                                        // Redirect to the new URL with the sort field and sort order
                                        window.location.href = "?sort_field=creation&creation=" + newSortOrder;
                                    });
                                </script>
                                <script>
                                    // Get the inquiry_id_sort element
                                    var updateIdSort = document.getElementById("update_sort");
                                
                                    // Read the current sort order from the query parameters in the URL
                                    var urlParams = new URLSearchParams(window.location.search);
                                    var currentSortOrder2 = urlParams.get('update');
                                
                                    // Set the initial arrow icon based on the current sort order
                                    var arrowIcon = updateIdSort.querySelector("span");
                                    arrowIcon.innerHTML = currentSortOrder2 === "asc" ? "&#8593;" : "&#8595;";
                                
                                    // Add a click event listener to the element
                                    updateIdSort.addEventListener("click", function() {
                                        // Toggle the sort order
                                        var newSortOrder = currentSortOrder2 === "asc" ? "desc" : "asc";
                                
                                        // Update the link href with the new sort field and sort order
                                        updateIdSort.href = '{{ inquiries_list }}' + "?sort_field=update&update=" + newSortOrder;
                                        
                                        // Redirect to the new URL with the sort field and sort order
                                        window.location.href = "?sort_field=update&update=" + newSortOrder;
                                    });
                                </script>
                            </th>
                            

                            {% if user.employee.position.name == 'admin' %}
                                <th ><strong>Updated with </strong></th>
                            {% endif %}

                            <th>
                                <strong id="customer_sort" style="cursor: pointer;" >Customer & Address <span>&#8595;</span></strong>
                                <script>
                                    // Get the inquiry_id_sort element
                                    var customerSort = document.getElementById("customer_sort");
                                
                                    // Read the current sort order from the query parameters in the URL
                                    var urlParams = new URLSearchParams(window.location.search);
                                    var currentSortOrdercustomer = urlParams.get('customer');
                                
                                    // Set the initial arrow icon based on the current sort order
                                    var arrowIcon = customerSort.querySelector("span");
                                    arrowIcon.innerHTML = currentSortOrdercustomer === "asc" ? "&#8593;" : "&#8595;";
                                
                                    // Add a click event listener to the element
                                    customerSort.addEventListener("click", function() {
                                        // Toggle the sort order
                                        var newSortOrder = currentSortOrdercustomer === "asc" ? "desc" : "asc";
                                
                                        // Update the link href with the new sort field and sort order
                                        customerSort.href = '{{ inquiries_list }}' + "?sort_field=customer&customer=" + newSortOrder;
                                        
                                        // Redirect to the new URL with the sort field and sort order
                                        window.location.href = "?sort_field=customer&customer=" + newSortOrder;
                                    });
                                </script>
                            </th>

                            <th >
                                <strong id="service_sort" style="cursor: pointer;" >services <span>&#8595;</span></strong><br>
                                <script>
                                    // Get the inquiry_id_sort element
                                    var serviceSort = document.getElementById("service_sort");
                                
                                    // Read the current sort order from the query parameters in the URL
                                    var urlParams = new URLSearchParams(window.location.search);
                                    var currentSortOrderservice = urlParams.get('service_sort');
                                
                                    // Set the initial arrow icon based on the current sort order
                                    var arrowIcon = serviceSort.querySelector("span");
                                    arrowIcon.innerHTML = currentSortOrderservice === "asc" ? "&#8593;" : "&#8595;";
                                
                                    // Add a click event listener to the element
                                    serviceSort.addEventListener("click", function() {
                                        // Toggle the sort order
                                        var newSortOrder = currentSortOrderservice === "asc" ? "desc" : "asc";
                                
                                        // Update the link href with the new sort field and sort order
                                        serviceSort.href = '{{ inquiries_list }}' + "?sort_field=service_sort&service_sort=" + newSortOrder;
                                        
                                        // Redirect to the new URL with the sort field and sort order
                                        window.location.href = "?sort_field=service_sort&service_sort=" + newSortOrder;
                                    });
                                </script>

                                <strong id="source_sort" style="cursor: pointer;" >source <span>&#8595;</span></strong><br>
                                <script>
                                    // Get the inquiry_id_sort element
                                    var sourceSort = document.getElementById("source_sort");
                                
                                    // Read the current sort order from the query parameters in the URL
                                    var urlParams = new URLSearchParams(window.location.search);
                                    var currentSortOrdersource = urlParams.get('source_sort');
                                
                                    // Set the initial arrow icon based on the current sort order
                                    var arrowIcon = sourceSort.querySelector("span");
                                    arrowIcon.innerHTML = currentSortOrdersource === "asc" ? "&#8593;" : "&#8595;";
                                
                                    // Add a click event listener to the element
                                    sourceSort.addEventListener("click", function() {
                                        // Toggle the sort order
                                        var newSortOrder = currentSortOrdersource === "asc" ? "desc" : "asc";
                                
                                        // Update the link href with the new sort field and sort order
                                        sourceSort.href = '{{ inquiries_list }}' + "?sort_field=source_sort&source_sort=" + newSortOrder;
                                        
                                        // Redirect to the new URL with the sort field and sort order
                                        window.location.href = "?sort_field=source_sort&source_sort=" + newSortOrder;
                                    });
                                </script>

                                <strong id="state_sort" style="cursor: pointer;" >state <span>&#8595;</span></strong>
                                <script>
                                    // Get the inquiry_id_sort element
                                    var stateSort = document.getElementById("state_sort");
                                
                                    // Read the current sort order from the query parameters in the URL
                                    var urlParams = new URLSearchParams(window.location.search);
                                    var currentSortOrderstate = urlParams.get('state_sort');
                                
                                    // Set the initial arrow icon based on the current sort order
                                    var arrowIcon = stateSort.querySelector("span");
                                    arrowIcon.innerHTML = currentSortOrderstate === "asc" ? "&#8593;" : "&#8595;";
                                
                                    // Add a click event listener to the element
                                    stateSort.addEventListener("click", function() {
                                        // Toggle the sort order
                                        var newSortOrder = currentSortOrderstate === "asc" ? "desc" : "asc";
                                
                                        // Update the link href with the new sort field and sort order
                                        stateSort.href = '{{ inquiries_list }}' + "?sort_field=state_sort&state_sort=" + newSortOrder;
                                        
                                        // Redirect to the new URL with the sort field and sort order
                                        window.location.href = "?sort_field=state_sort&state_sort=" + newSortOrder;
                                    });
                                </script>
                            </th>

                            <th>
                                <strong id="sp_sort" style="cursor: pointer;">Service Provider <span>&#8595;</span></strong>
                                <script>
                                    // Get the inquiry_id_sort element
                                    var spSort = document.getElementById("sp_sort");
                                    
                                    // Read the current sort order from the query parameters in the URL
                                    var urlParams = new URLSearchParams(window.location.search);
                                    var currentSortOrdersp = urlParams.get('sp_sort');
                                    
                                    // Set the initial arrow icon based on the current sort order
                                    var arrowIcon = spSort.querySelector("span");
                                    arrowIcon.innerHTML = currentSortOrdersp === "asc" ? "&#8593;" : "&#8595;";
                                    
                                    // Add a click event listener to the element
                                    spSort.addEventListener("click", function() {
                                        // Toggle the sort order
                                        var newSortOrder = currentSortOrdersp === "asc" ? "desc" : "asc";
                                    
                                        // Update the link href with the new sort field and sort order
                                        spSort.href = '{{ inquiries_list }}' + "?sort_field=sp_sort&sp_sort=" + newSortOrder;
                                        
                                        // Redirect to the new URL with the sort field and sort order
                                        window.location.href = "?sort_field=sp_sort&sp_sort=" + newSortOrder;
                                    });
                                </script>
                            </th>
                            <th style="cursor: pointer;" ><strong>have media </strong></th>
                            <th style="cursor: pointer;" ><strong>canceling causes </strong></th>
                            <th style="cursor: pointer;" ><strong>advenced price </strong></th>
                            <th ><strong style="cursor: pointer;" >total price </strong></th>
                            <th style="cursor: pointer;"><strong>percentage </strong></th>
                            <th style="cursor: pointer;"><strong>Map </strong></th>


                            <!-- Add other columns as needed -->
                        </tr>
                    </thead>


                    <script>
                        var ascending = true; // Flag to track sorting order
                        
                        function sortTable(columnIndex) {
                            var table, rows, switching, i, x, y, shouldSwitch;
                            table = document.querySelector('.table'); // Assuming your table has the 'table' class
                            switching = true;
                            
                            while (switching) {
                                switching = false;
                                rows = table.rows;
                                
                                for (i = 1; i < (rows.length - 1); i++) {
                                    shouldSwitch = false;
                                    
                                    x = rows[i].getElementsByTagName("td")[columnIndex];
                                    y = rows[i + 1].getElementsByTagName("td")[columnIndex];
                                    
                                    if (ascending) {
                                        if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
                                            shouldSwitch = true;
                                            break;
                                        }
                                    } else {
                                        if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
                                            shouldSwitch = true;
                                            break;
                                        }
                                    }
                                }
                                
                                if (shouldSwitch) {
                                    rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                                    switching = true;
                                }
                            }
                            
                            // Toggle sorting order for next click
                            ascending = !ascending;
                        }
                    </script>


                    <tbody>
                        {% for inquiry in inquiries %}
                            <tr>
                                {% if inquiry.state.status.name == "new" %}
                                    <td style="background-color:  #abd08e ; color: black;">
                                        <div class="line">Inquiry ID : {{ inquiry.info.id }}</div>
                                        <div class="line">customer ID : {{ inquiry.info.customer.id }}</div>
                                    </td>
                                {% elif inquiry.state.status.name == "connecting" %}
                                    <td style="background-color:  #ffd4ba ; color: black;">
                                        <div class="line">Inquiry ID : {{ inquiry.info.id }}</div>
                                        <div class="line">customer ID : {{ inquiry.info.customer.id }}</div>
                                    </td>
                                {% elif inquiry.state.status.name == "send Q or B" %}
                                    <td style="background-color: #afc1ef; color: black;">
                                        <div class="line">Inquiry ID : {{ inquiry.info.id }}</div>
                                        <div class="line">customer ID : {{ inquiry.info.customer.id }}</div>
                                    </td>
                                {% elif inquiry.state.status.name == "pending" %}
                                    <td style="background-color: #f4af85; color: black;">
                                        <div class="line">Inquiry ID : {{ inquiry.info.id }}</div>
                                        <div class="line">customer ID : {{ inquiry.info.customer.id }}</div>
                                    </td>
                                {% elif inquiry.state.status.name == "underproccess" %}
                                    <td style="background-color: #ffe699; color: black;">
                                        <div class="line">Inquiry ID : {{ inquiry.info.id }}</div>
                                        <div class="line">customer ID : {{ inquiry.info.customer.id }}</div>
                                    </td>
                                {% elif inquiry.state.status.name == "cancel" %}
                                    <td style="background-color: #cfcfcf; color: rgb(224, 20, 20);">
                                        <div class="line">Inquiry ID : {{ inquiry.info.id }}</div>
                                        <div class="line">customer ID : {{ inquiry.info.customer.id }}</div>
                                    </td>
                                {% elif inquiry.state.status.name == "complain" %}
                                    <td style="background-color: #ff4646; color: rgb(0, 0, 0);">
                                        <div class="line">Inquiry ID : {{ inquiry.info.id }}</div>
                                        <div class="line">customer ID : {{ inquiry.info.customer.id }}</div>
                                    </td>
                                {% elif inquiry.state.status.name == "done" %}
                                    <td style="background-color: #ffffff; color: rgb(0, 0, 0);">
                                        <div class="line">Inquiry ID : {{ inquiry.info.id }}</div>
                                        <div class="line">customer ID : {{ inquiry.info.customer.id }}</div>
                                    </td>
                                {% else %}
                                    <td>
                                        <div class="line">Inquiry ID : {{ inquiry.info.id }}</div>
                                        <div class="line">customer ID : {{ inquiry.info.customer.id }}</div>
                                    </td>
                                {% endif %}

                                <td style="width: 200px;">
                                    <div class="line">Created : {{ inquiry.info.date_inq }}</div>
                                    <div class="line">Updated : {{ inquiry.state.update }}</div>
                                </td>
                                
                                {% if user.employee.position.name == 'admin' %}
                                    <td>{{ inquiry.action.from_employee }}</td>
                                {% endif %}

                                <td>
                                    {% if user.employee.position.name == 'call center' or user.employee.position.name == 'super provider' or user.employee.position.name == 'admin' %}
                                        <a href="{% url 'inquiry_info' inquiry.info.id %}">{{ inquiry.info.customer.first_name }} - {{ inquiry.info.address.address_name }}</a>
                                    {% else %}
                                        {{ inquiry.info.customer.first_name }} - {{ inquiry.info.address.address_name }}
                                    {% endif %}

                                    {% if user.employee.permissions.all %}
                                        {% for permission in user.employee.permissions.all %}
                                            {% if permission.name == "inquiry info" %}
                                                <a href="{% url 'inquiry_info' inquiry.info.id %}">{{ inquiry.info.customer.first_name }} - {{ inquiry.info.address.address_name }}</a>
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                </td>
                                
                                <td>
                                    <div class="line">Service : {{ inquiry.info.services }}</div>
                                    <div class="line">Source : {{ inquiry.info.source }}</div> 
                                    <div class="line">Status : {{ inquiry.state.status }}</div>
                                </td>

                                <td>
                                    <div class="line">{{ inquiry.info.sp }}</div>
                                </td>
                                
                                {% if inquiry.info.cloudinary_urls %} 
                                    <td style="color: #66c31f;"> Yes <div id="mediacount-{{inquiry.info.id}}"></div> </td>
                                    <script>
                                        var cloudinaryUrls = "{{ inquiry.info.cloudinary_urls }}"; // Get the URLs
                                        var urlsArray = cloudinaryUrls.split(',**,'); // Split by the delimiter
                                        var numberOfUrls = urlsArray.length; // Count the number of URLs
                                        console.log('count: '+numberOfUrls)
                                        document.getElementById("mediacount-{{inquiry.info.id}}").innerText = numberOfUrls; // Update the cell with the count
                                    </script>
                                {% else %} 
                                    <td style="color: #dc2215;"> No </td>
                                {% endif %}

                                <td>{% if inquiry.state.canceling_causes %}{{ inquiry.state.canceling_causes }}{% else %} not canceled {% endif %}</td>

                                {% if inquiry.state.status.name == "underproccess" %}
                                    <td style="min-width: 200px;" >
                                        <form method="post" action="{% url 'add_advence' inquiry.info.id %}" >
                                            {% csrf_token %}
                                            <div style="display: flex;">
                                                <input id="advence_price" type="number" name="advence_price" class="form-control mr-2">
                                                <button class="btn btn-sm btn-success" type="submit">Add price</button>
                                            </div>
                                        </form>
                                    </td>

                                    <td>{{ inquiry.totale }}</td>

                                    <td id="percentage-{{inquiry.info.id}}"></td>
                                {% else %}
                                    <td> Null </td>

                                    <td> Null </td>

                                    <td> Null </td>
                                {% endif %}

                                <script>
                                    if (parseInt("{{ inquiry.totale }}") != 0) {
                                        // Calculate the percentage
                                        var percentage = (parseInt("{{inquiry.advence.price}}") / parseInt("{{ inquiry.totale }}") ) * 100;

                                        console.log(percentage)
                                        // Update the content of the <td> element with id "percentage"
                                        var advencePrice = {{ inquiry.advence.price }};
                                        var formattedPercentage = '(' + advencePrice + ')' + '<br>' + percentage.toFixed(2) + "%";
                                        document.getElementById("percentage-{{inquiry.info.id}}").innerHTML  = formattedPercentage;

                                    } else {
                                        document.getElementById("percentage-{{inquiry.info.id}}").textContent = 'None';

                                    }

                                </script>

                                <td> <a href="{{ inquiry.info.address.location_url }}" target="_blank">{{ inquiry.info.address.location }}</a></td>




                                <!-- Add other columns as needed -->
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <h4>
                    <!-- Add this block above or below your table -->
                    <div class="pagination">
                        <span class="step-links">
                            {% if inquiries_with_pages.has_previous %}
                                <a href="?page=1">&laquo; first</a>
                                <a href="?page={{ inquiries_with_pages.previous_page_number }}">previous</a>
                            {% endif %}

                            <span class="current">
                                Page {{ inquiries_with_pages.number }} of {{ inquiries_with_pages.paginator.num_pages }}.
                            </span>

                            {% if inquiries_with_pages.has_next %}
                                <a href="?page={{ inquiries_with_pages.next_page_number }}">next</a>
                                <a href="?page={{ inquiries_with_pages.paginator.num_pages }}">last &raquo;</a>
                            {% endif %}
                        </span>
                    </div>
                </h4>
            </div>

        </div>
<!-- ######################################################################### -->

        <!-- Content: Start -->
        {% if is_flex %}
        <div class="{{container_class}} d-flex align-items-stretch flex-grow-1 p-0">
        {% else %}
        <div class="{{container_class}} flex-grow-1 container-p-y">
            {% endif %}
            {% block content %}
            {% endblock content %}

        </div>
        <!-- / Content: End -->

        <!--{% if is_footer %}
            Footer: Start 
        {% include "parts/footer.html" %}
            Footer: End 
        {% endif %}-->

        <div class="content-backdrop fade"></div>
        </div>
        <!--/ Content wrapper: End -->
    </div>

    <script>
        // Function to fetch and update content
        function refreshContent() {
            $.ajax({
                url: window.location.href,
                type: 'GET',
                success: function(data) {
                    // Extract the HTML content within the #update element from the response data
                    var updatedContent = $(data).find('#update').html();
                    console.log(updatedContent)
                    
                    // Replace the content within the #update element with the updated content
                    $('#update').html(updatedContent);
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching content:', error);
                }
            });
        }
        
        // Call the refreshContent function every 10 seconds
        setInterval(refreshContent, 10000); // 10000 milliseconds = 10 seconds
    </script>
    <!-- / Layout page: End -->
    </div>

    {% if is_menu %}
    <!-- Overlay -->
    <div class="layout-overlay layout-menu-toggle"></div>
    {% endif %}
    <!-- Drag Target Area To SlideIn Menu On Small Screens -->
    <div class="drag-target"></div>
</div>
<!-- Layout wrapper: End -->
{% endblock layout %}
